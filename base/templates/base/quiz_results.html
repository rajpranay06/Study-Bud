{% extends 'main.html' %}

{% block content %}
<main class="layout layout--2">
    <div class="container quiz-container">
        <div class="quiz-header">
            <h1>{{ quiz.title }}</h1>
            <div class="quiz-meta">
                <span>Topic: <strong>{{ topic }}</strong></span>
                <span>Difficulty: <strong>{{ difficulty }}</strong></span>
                <span>Recommended Time: <strong>{{ quiz.recommendedTimeInMinutes }} minutes</strong></span>
            </div>
        </div>

        <form id="quizForm" method="POST" action="{% url 'submit-quiz' room.id %}">
            {% csrf_token %}
            <div class="quiz-questions">
                {% for question in quiz.questions %}
                <div class="quiz-question">
                    <h3>{{ forloop.counter }}. {{ question.question }}</h3>
                    <div class="quiz-options">
                        {% for option in question.options %}
                        <div class="quiz-option">
                            <input type="radio" id="q{{ forloop.parentloop.counter }}_opt{{ forloop.counter }}" 
                                   name="question_{{ forloop.parentloop.counter }}" 
                                   value="{{ forloop.counter }}">
                            <label for="q{{ forloop.parentloop.counter }}_opt{{ forloop.counter }}">
                                {{ option }}
                            </label>
                        </div>
                        {% endfor %}
                    </div>
                    <div class="explanation" style="display: none;">
                        <p>{{ question.explanation }}</p>
                    </div>
                </div>
                {% endfor %}
            </div>

            <div class="quiz-actions">
                <button type="button" id="checkAnswers" class="btn btn-primary">Check Answers</button>
                <button type="button" id="tryAgain" class="btn btn-secondary" style="display: none;">Try Another Quiz</button>
                <a href="{% url 'room' room.id %}" class="btn btn-secondary">Back to Room</a>
            </div>
        </form>
    </div>
</main>

<style>
    .quiz-container {
        max-width: 800px;
        margin: 0 auto;
        background-color: var(--color-dark);
        border-radius: 10px;
        padding: 2rem;
        margin-top: 2rem;
        margin-bottom: 2rem;
    }

    .quiz-header {
        margin-bottom: 2rem;
        border-bottom: 1px solid var(--color-dark-light);
        padding-bottom: 1rem;
    }

    .quiz-meta {
        display: flex;
        gap: 1.5rem;
        font-size: 0.9rem;
        color: var(--color-light-gray);
        margin-top: 0.5rem;
    }

    .quiz-questions {
        display: flex;
        flex-direction: column;
        gap: 2rem;
    }

    .quiz-question {
        border: 1px solid var(--color-dark-light);
        border-radius: 5px;
        padding: 1.5rem;
        background-color: var(--color-dark-medium);
    }

    .quiz-question h3 {
        margin-bottom: 1rem;
    }

    .quiz-options {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .quiz-option {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem;
        border-radius: 5px;
        transition: background-color 0.2s;
    }

    .quiz-option:hover {
        background-color: var(--color-dark);
    }

    .quiz-option input[type="radio"] {
        accent-color: var(--color-main);
    }

    .quiz-option label {
        cursor: pointer;
        flex-grow: 1;
    }

    .quiz-actions {
        margin-top: 2rem;
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
    }

    .explanation {
        margin-top: 1rem;
        padding: 1rem;
        background-color: var(--color-dark);
        border-radius: 5px;
        border-left: 4px solid var(--color-main);
    }

    .correct {
        background-color: rgba(0, 128, 0, 0.2);
        border: 1px solid rgba(0, 128, 0, 0.4);
        border-radius: 5px;
        position: relative;
    }
    
    .correct::after {
        content: "✓";
        position: absolute;
        right: 10px;
        color: #2ecc71;
        font-weight: bold;
    }

    .incorrect {
        background-color: rgba(220, 53, 69, 0.2);
        border: 1px solid rgba(220, 53, 69, 0.4);
        border-radius: 5px;
        position: relative;
    }
    
    .incorrect::after {
        content: "✗";
        position: absolute;
        right: 10px;
        color: #e74c3c;
        font-weight: bold;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const checkAnswersBtn = document.getElementById('checkAnswers');
        const tryAgainBtn = document.getElementById('tryAgain');
        const quizQuestions = document.querySelectorAll('.quiz-question');

        // Store correct answers
        const correctAnswers = [
            {% for question in quiz.questions %}
                {% if question.correctAnswer == "A" %}0{% elif question.correctAnswer == "B" %}1{% elif question.correctAnswer == "C" %}2{% elif question.correctAnswer == "D" %}3{% else %}0{% endif %}{% if not forloop.last %},{% endif %}
            {% endfor %}
        ];
        
        console.log('Correct answers array:', correctAnswers);

        checkAnswersBtn.addEventListener('click', function() {
            console.log('Check Answers button clicked');
            let score = 0;
            
            quizQuestions.forEach((question, idx) => {
                const options = question.querySelectorAll('.quiz-option');
                const explanation = question.querySelector('.explanation');
                const selectedOption = question.querySelector('input[type="radio"]:checked');
                
                console.log(`Question ${idx+1}: Correct answer is option ${correctAnswers[idx]+1}`);
                
                // Show explanation
                explanation.style.display = 'block';
                
                // If user selected an answer
                if (selectedOption) {
                    const userAnswer = parseInt(selectedOption.value) - 1;
                    console.log(`User selected option ${userAnswer+1}`);
                    
                    // Reset any previous styling
                    options.forEach(opt => {
                        opt.classList.remove('correct', 'incorrect');
                    });
                    
                    // Mark the correct answer
                    options[correctAnswers[idx]].classList.add('correct');
                    
                    // If user's answer is incorrect, mark it
                    if (userAnswer !== correctAnswers[idx]) {
                        options[userAnswer].classList.add('incorrect');
                    } else {
                        score++;
                    }
                } else {
                    console.log('No option selected');
                    // No answer selected, just mark the correct one
                    options[correctAnswers[idx]].classList.add('correct');
                }
            });
            
            // Disable all inputs after checking
            document.querySelectorAll('.quiz-option input').forEach(input => {
                input.disabled = true;
            });
            
            // Update UI
            console.log(`Final score: ${score}/${correctAnswers.length}`);
            checkAnswersBtn.textContent = `Your Score: ${score}/${correctAnswers.length}`;
            checkAnswersBtn.disabled = true;
            tryAgainBtn.style.display = 'block';
        });
        
        tryAgainBtn.addEventListener('click', function() {
            // Redirect back to room and trigger quiz form to open
            window.location.href = "{% url 'room' room.id %}?openQuizForm=true";
        });
    });
</script>
{% endblock content %} 